<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring事务 | 小让の糖果屋</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.ico">
    <script charset="utf-8" async="async" src="/blog/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/blog/js/global.js"></script>
    <script charset="utf-8" async="async" src="/blog/js/fingerprint2.min.js"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?0b31b4c146bf7126aed5009e1a4a11c8";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础, Java设计模式, 数据结构与算法, 源码分析...">
    <meta property="article:modified_time" content="2022-11-12T23:53:01.000Z">
    <meta property="og:title" content="Spring事务">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html">
    <meta name="twitter:title" content="Spring事务">
    <meta name="twitter:url" content="/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="spring, transaction">
    <meta property="article:tag" content="spring">
    <meta name="robots" content="all">
    <meta name="author" content="小让">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="小让の糖果屋, 数据结构与算法, 设计模式, 源码分析, Java基础, 八股文">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/blog/assets/css/0.styles.81cff77c.css" as="style"><link rel="preload" href="/blog/assets/css/styles.css?v=1668302853734" as="style"><link rel="preload" href="/blog/assets/js/cg-styles.js?v=1668302853734" as="script"><link rel="preload" href="/blog/assets/js/cg-app.js?v=1668302853734" as="script"><link rel="preload" href="/blog/assets/js/cg-3.js?v=1668302853734" as="script"><link rel="preload" href="/blog/assets/js/cg-4.js?v=1668302853734" as="script"><link rel="preload" href="/blog/assets/js/cg-22.js?v=1668302853734" as="script">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.81cff77c.css"><link rel="stylesheet" href="/blog/assets/css/styles.css?v=1668302853734">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">小让の糖果屋</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/md/other/guide-to-reading.html" class="nav-link">
  导读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/数据结构与算法/数据结构/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/数据结构与算法/算法/排序算法/冒泡排序.html" class="nav-link">
  算法主题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/java/interview/HashMap.html" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/java/core/" class="nav-link">
  基础技术
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/spring/基础/IOC/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/springmvc/基础/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/spring-security/基础/" class="nav-link">
  SpringSecurity
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/md/other/guide-to-reading.html" class="nav-link">
  导读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/数据结构与算法/数据结构/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/数据结构与算法/算法/排序算法/冒泡排序.html" class="nav-link">
  算法主题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/java/interview/HashMap.html" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/java/core/" class="nav-link">
  基础技术
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><span class="title">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/spring/基础/IOC/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/springmvc/基础/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/blog/md/spring全家桶/spring-security/基础/" class="nav-link">
  SpringSecurity
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/md/spring全家桶/spring/基础/IOC.html" class="sidebar-link">Spring-IOC</a></li><li><a href="/blog/md/spring全家桶/spring/基础/AOP.html" class="sidebar-link">Spring-AOP</a></li><li><a href="/blog/md/spring全家桶/spring/基础/JDBC.html" class="sidebar-link">Spring-JDBC</a></li><li><a href="/blog/md/spring全家桶/spring/基础/事务.html" class="active sidebar-link">Spring事务</a></li><li><a href="/blog/md/spring全家桶/spring/基础/Spring注解驱动开发.html" class="sidebar-link">Spring注解驱动开发</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/md/spring全家桶/spring/源码/Spring源码环境搭建.html" class="sidebar-link">Spring源码环境搭建</a></li><li><a href="/blog/md/spring全家桶/spring/源码/Spring注册Bean的几种方式.html" class="sidebar-link">Spring注册Bean的几种方式</a></li><li><a href="/blog/md/spring全家桶/spring/源码/Spring-BeanDefinition加载流程分析.html" class="sidebar-link">Spring-BeanDefinition加载流程分析</a></li><li><a href="/blog/md/spring全家桶/spring/源码/Spring-ConfigurationClassPostProcessor后置处理器详解.html" class="sidebar-link">Spring-ConfigurationClassPostProcessor后置处理器详解</a></li><li><a href="/blog/md/spring全家桶/spring/源码/Spring事件订阅与发布原理分析.html" class="sidebar-link">Spring事件订阅与发布原理分析</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="spring-事务模块"><a href="#spring-事务模块" class="header-anchor">#</a> Spring- 事务模块</h1> <h2 id="_1-环境搭建"><a href="#_1-环境搭建" class="header-anchor">#</a> 1. 环境搭建</h2> <blockquote><p>本章节所涉及到的代码在 <a href="https://github.com/xihuanxiaorang/spring-study" target="_blank" rel="noopener noreferrer">GitHub - xihuanxiaorang/spring-study: 用于spring学习<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 仓库中的 <code>transaction</code> 模块，可以自行查看。</p></blockquote> <h3 id="_1-1-创建-spring-study-transaction-模块"><a href="#_1-1-创建-spring-study-transaction-模块" class="header-anchor">#</a> 1.1. 创建 spring-study-transaction 模块</h3> <p>选中项目右键新建一个模块，模块名填自己喜欢的即可，这里我就填 <code>spring-study-transaction</code>，最后点击确定即可。</p> <p><img alt="|1261" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130622.png" loading="lazy" class="lazy"></p> <h3 id="_1-2-引入相关依赖"><a href="#_1-2-引入相关依赖" class="header-anchor">#</a> 1.2. 引入相关依赖</h3> <p>在模块的 <code>pom.xml</code> 配置文件中引入以下依赖：由于本次 <code>transaction</code> 模块需要用到 <code>jdbc</code> 模块中已经配置好的组件，所以将 <code>jdbc</code> 模块引入进来，还有 <code>spring-tx</code> 依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>top.xiaorang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-study-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-tx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_1-3-引入日志配置文件"><a href="#_1-3-引入日志配置文件" class="header-anchor">#</a> 1.3. 引入日志配置文件</h3> <p>由于引入了 <code>logback</code>，所以需要在资源目录 <code>resources</code> 下创建一个 <code>logback.xml</code> 配置文件：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5p %c{1}:%L - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5p %c{1}:%L - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>charset</span><span class="token punctuation">&gt;</span></span>utf-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>charset</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>log/output.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.FixedWindowRollingPolicy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>log/output.log.%i<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>triggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxFileSize</span><span class="token punctuation">&gt;</span></span>1MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxFileSize</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>triggeringPolicy</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_1-4-事务配置类"><a href="#_1-4-事务配置类" class="header-anchor">#</a> 1.4. 事务配置类</h3> <p>向 Spring 容器中注入一个 <code>PlatformTransactionManager</code> 的实现类 <code>DataSourceTransactionManager</code> 组件。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceTransactionManager</span> <span class="token function">dataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-5-主配置类"><a href="#_1-5-主配置类" class="header-anchor">#</a> 1.5. 主配置类</h3> <p>扫描模块下的所有组件，以及向 Spring 容器中导入 <code>jdbc</code> 模块中的主配置类（这样可以让 <code>jdbc</code> 模块中的组件注册到 Spring 容器中，否则的话，获取不到 <code>jdbc</code> 模块中配置好的组件），最后向 Spring 容器中注入一个 <code>TransactionTemplate</code> 组件。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;top.xiaorang.spring.transaction&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name"><span class="token namespace">top<span class="token punctuation">.</span>xiaorang<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span>transactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样，环境就搭建好了！可以基于该环境去分别测试编程式事务和声明式事务这两种不同的用法。</p> <h2 id="_2-三大基础设施"><a href="#_2-三大基础设施" class="header-anchor">#</a> 2. 三大基础设施</h2> <p>Spring 中对事务的支持提供了三大基础设施：</p> <ol><li><code>PlatformTransactionManager</code></li> <li><code>TransactionDefinition</code></li> <li><code>TransactionStatus</code></li></ol> <p>这三个类是 Spring 处理事务的核心类。</p> <h3 id="_2-1-platformtransactionmanager"><a href="#_2-1-platformtransactionmanager" class="header-anchor">#</a> 2.1. PlatformTransactionManager</h3> <p><code>PlatformTransactionManager</code> 是事务处理的核心，他有诸多的实现类，如下所示：</p> <p><img alt="|936" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130254.png" loading="lazy" class="lazy"></p> <p><code>PlatformTransactionManager</code> 接口定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionManager</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到 <code>PlatformTransactionManager</code> 中定义了基本的事务操作方法，这些事务操作方法都与平台无关，具体的实现都是由不同的子类来实现的。</p> <p>这就像 <code>JDBC</code> 一样，SUN 公司制定标准，其他数据库厂商提供具体的实现。这么做的好处就是咱们只需要掌握好这套标准即可，不用去管接口的具体实现。以 <code>PlatformTransactionManager</code> 为例，它有众多实现，如果你使用的是 <code>JDBC</code> 那么可以将 <code>DataSourceTransactionManager</code> 作为事务管理器；如果你使用的是 <code>Hibernate</code>，那么可以将 <code>HibernateTransactionManager</code> 作为事务管理器；如果你使用的是 <code>JPA</code>，那么可以将 <code>JpaTransactionManager</code> 作为事务管理器。<code>DataSourceTransactionManager</code>、<code>HibernateTransactionManager</code> 以及 <code>JpaTransactionManager</code> 都只是 <code>PlatformTransactionManager</code> 的具体实现，但是咱们并不需要掌握这些具体实现类的用法，只需要掌握好 <code>PlatformTransactionManager</code> 的用法即可。</p> <p><code>PlatformTransactionManager</code> 中主要有如下三个方法：</p> <ol><li><code>getTransaction()</code> 方法会根据传入的 <code>TransactionDefinition</code> 获取一个事务对象，<code>TransactionDefinition</code> 中定义了一些事务的基本规则，如传播性、隔离级别等。</li> <li><code>commit()</code> 方法用于提交事务。</li> <li><code>rollback()</code> 方法用于回滚事务。</li></ol> <h3 id="_2-2-transactiondefinition"><a href="#_2-2-transactiondefinition" class="header-anchor">#</a> 2.2. TransactionDefinition</h3> <p><code>TransactionDefinition</code> 用来描述事务的具体规则，也成为事务的属性。事务有哪些属性呢？主要包括如下 5 个属性：</p> <ol><li>隔离性</li> <li>传播性</li> <li>回滚规则</li> <li>超时时间</li> <li>是否只读</li></ol> <p><code>TransactionDefinition</code> 接口定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionDefinition</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_REQUIRED</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_SUPPORTS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_MANDATORY</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_REQUIRES_NEW</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_NOT_SUPPORTED</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_NEVER</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">PROPAGATION_NESTED</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">ISOLATION_DEFAULT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">ISOLATION_READ_UNCOMMITTED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">ISOLATION_READ_COMMITTED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">ISOLATION_REPEATABLE_READ</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">ISOLATION_SERIALIZABLE</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token constant">TIMEOUT_DEFAULT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">TransactionDefinition</span> <span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">StaticTransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>可以看到一共有 5 个方法：</p> <ol><li><code>getPropagationBehavior()</code> 方法，用于获取事务的传播性</li> <li><code>getIsolationLevel()</code> 方法，用于获取事务的隔离级别</li> <li><code>getTimeout()</code> 方法，用于获取事务的超时时间</li> <li><code>getName()</code> 方法，用于获取事务的名称</li> <li><code>isReadOnly()</code> 方法，用于获取事务是否是只读事务</li></ol> <p><code>TransactionDefinition</code> 也有诸多实现类，如下所示：</p> <p><img alt="|916" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130233.png" loading="lazy" class="lazy"></p> <p>如果是使用编程式事务进行开发的话，使用 <code>DefaultTransactionDefinition</code> 即可。</p> <h3 id="_2-3-transactionstatus"><a href="#_2-3-transactionstatus" class="header-anchor">#</a> 2.3. TransactionStatus</h3> <p><code>TransactionStatus</code> 可以直接理解为事务本身，接口定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionStatus</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionExecution</span><span class="token punctuation">,</span> <span class="token class-name">SavepointManager</span><span class="token punctuation">,</span> <span class="token class-name">Flushable</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>该接口继承自 <code>TransactionExecution</code>、<code>SavepointManager</code> 和 <code>Flushable</code> 接口，所以也就具备这些接口所拥有的能力。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionExecution</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SavepointManager</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> <span class="token function">createSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">rollbackToSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">releaseSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Flushable</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Flushes this stream by writing any buffered output to the underlying
     * stream.
     *
     * @throws IOException If an I/O error occurs
     */</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ol><li><code>hasSavepoint()</code> 方法用于判断当前是否存在保存点</li> <li><code>flush()</code> 方法用于将底层会话中的修改刷新到数据库，一般用于 <code>Hibernate/JPA</code> 的会话，对如 <code>JDBC</code> 类型的事务无任何影响</li> <li><code>isNewTransaction()</code> 方法用于判断当前事务是否是一个新事务</li> <li><code>setRollbackOnly()</code> 方法用于设置事务必须回滚</li> <li><code>isRollbackOnly()</code> 方法用于判断事务是否只能回滚</li> <li><code>isCompleted()</code> 方法用于判断事务是否已经结束</li> <li><code>createSavepoint()</code> 方法用于创建一个保存点</li> <li><code>rollbackToSavepoint(Object savepoint)</code> 方法用于回滚到保存点</li></ol> <p><strong>以上就是 Spring 中支持事务的三大基础设施</strong>。</p> <h2 id="_3-两种用法"><a href="#_3-两种用法" class="header-anchor">#</a> 3. 两种用法</h2> <p>Spring 作为 Java 开发中的基础设施，对于事务也提供了很好的支持，总体上来说，Spring 支持两种类型的事务，<strong>编程式事务</strong> 和 <strong>声明式事务</strong>。其中，编程式事务类似于 JDBC 事务的写法，需要将事务的代码嵌入到业务逻辑中，这样代码的耦合度较高，而声明式事务通过 AOP 的思想能够有效的将事务和业务逻辑代码解耦，因此在实际开发中，声明式事务得到广泛的应用，而编程式事务则较少使用。</p> <h3 id="_3-1-编程式事务"><a href="#_3-1-编程式事务" class="header-anchor">#</a> 3.1. 编程式事务</h3> <p>咱们先来看下编程式事务怎么玩。</p> <p>通过 <code>PlatformTransactionManager</code> 或者 <code>TransactionTemplate</code> 可以实现编程式事务。如果是在 SpringBoot 项目中，这两个对象 SpringBoot 会自动提供，咱们直接使用即可。但是如果是在传统的 SSM 项目中，则需要咱们通过配置来提供这两个对象，在环境搭建环节已经成功这两个对象注入到 Spring 容器中，现在直接拿出来用即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TransService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManager <span class="token operator">=</span> transactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultTransactionDefinition</span> transactionDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransactionStatus</span> transactionStatus <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>transactionDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>transactionStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>transactionStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这段代码很简单，没啥好解释的，在 <code>try...catch...</code> 中进行业务操作，没问题就 <code>commit</code>，有问题就 <code>rollback</code>。如果我们需要配置事务的隔离性、传播性等，可以在 <code>DefaultTransactionDefinition</code> 对象中进行配置。</p> <p>测试结果如下所示：</p> <p><img alt="" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130670.png" loading="lazy" class="lazy"></p> <p>上面的代码是通过 <code>PlatformTransactionManager</code> 实现的编程式事务，我们也可以通过 <code>TransactionTemplate</code> 来实现编程式事务，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransService</span> <span class="token punctuation">{</span>  
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>  
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionTemplate</span> transactionTemplate<span class="token punctuation">;</span>  
  
    <span class="token keyword">public</span> <span class="token class-name">TransService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">TransactionTemplate</span> transactionTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>transactionTemplate <span class="token operator">=</span> transactionTemplate<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        transactionTemplate<span class="token punctuation">.</span><span class="token function">executeWithoutResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span>transactionStatus<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>  
            jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>直接注入 <code>TransactionTemplate</code>，然后在 <code>action()</code> 回调方法方法中书写核心业务即可。上面这种不需要获取事务执行的结果，直接使用 <code>executeWithoutResult()</code> 方法即可；如果想要获取事务的执行结果，则使用 <code>execute()</code> 方法。</p> <p>测试结果如下所示：其实与通过 <code>PlatformTransactionManager</code> 实现编程式事务这种方式没有什么区别，只不过 <code>TransactionTemplate</code> 对 <code>PlatformTransactionManager</code> 操作进一步封装了而已。</p> <p><img alt="" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130265.png" loading="lazy" class="lazy"></p> <p>这就是两种编程式事务的玩法。由于编程式事务代码侵入性太严重了，因此在实际开发中很少使用，在咱们的项目中使用的更多的是声明式事务。</p> <h3 id="_3-2-声明式事务"><a href="#_3-2-声明式事务" class="header-anchor">#</a> 3.2. 声明式事务</h3> <p>声明式事务如果使用 <code>XML</code> 配置，可以做到无侵入；如果使用 <code>Java</code> 配置，也只有一个 <code>@Transactional</code> 注解侵入而已，相对来说非常容易。</p> <p>以下配置针对传统 SSM 项目（因为在 SpringBoot 项目中，事务相关的组件已经配置好了）：</p> <h4 id="_3-2-1-xml-配置"><a href="#_3-2-1-xml-配置" class="header-anchor">#</a> 3.2.1. XML 配置</h4> <p><code>XML</code> 配置声明式事务大致上可以分为四个步骤，如下：</p> <ol><li><p>配置数据源</p> <p>如果使用 <code>XML</code> 并且不配置包扫描的话，则需要将 <code>jdbc</code> 模块中配置好的数据源 <code>DataSource</code> 和 <code>JdbcTemplate</code> 组件在配置文件中再配置一份。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/context<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:db.properties<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zaxxer.hikari.HikariDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driverClassName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.driverClassName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbcUrl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.password}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>connectionTimeout<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.connectionTimeout}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>readOnly<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.readOnly}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>idleTimeout<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.pool.idleTimeout}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>maxLifetime<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.pool.maxLifetime}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>maximumPoolSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.pool.maxPoolSize}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>minimumIdle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.pool.minIdle}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbcTemplate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.core.JdbcTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li> <li><p>配置事务管理器</p> <p>其中的 <code>TransactionTemplate</code> 可配可不配，只是为了事务操作时方便</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionTemplate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.transaction.support.TransactionTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>配置事务通知</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m4<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>配置 AOP</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pc<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* top.xiaorang.spring.transaction.service.*.*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pc<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol> <p>第三步与第四步中定义出来的方法交集，就是咱们要添加事务的方法。</p> <p>配置完成之后，如下一些方法就自动具备事务了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>咱们来测试一下效果，不过在测试之前，需要再在 <code>XML</code> 配置文件中将 <code>UserService</code> 组件注入到 Spring 容器中。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top.xiaorang.spring.transaction.service.UserService<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbcTemplate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbcTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>测试类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;classpath:applicationContext.xml&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">SpringExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>点击测试按钮，报错信息居然不是 <code>/ by Zero</code>，而是报找不到 <code>AspectJExpressionPointcut</code> 类。</p> <p><img alt="" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130790.png" loading="lazy" class="lazy"></p> <p>所以咱们猜想应该还需要引入 <code>AOP</code> 相关依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-aspects<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>由于在 <code>aop</code> 模块咱们已经引入了 <code>AOP</code> 相关依赖，所以咱们可以直接引入 <code>aop</code> 模块即可。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>top.xiaorang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-study-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再次点击测试按钮，测试结果如下所示：虽然报错了，但是符合咱们的预期，从日志信息可以发现与编程式事务没有什么区别。</p> <p><img alt="image-20221022030808751" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130464.png" loading="lazy" class="lazy"></p> <h4 id="_3-2-2-java-配置"><a href="#_3-2-2-java-配置" class="header-anchor">#</a> 3.2.2. Java 配置</h4> <p>咱们也可以使用 <code>Java</code> 配置这种方式来实现声明式事务，这种方式就不再需要 <code>XML</code> 配置文件了，只需要在咱们的主配置类 <code>MainConfig</code> 加上 <code>@EnableTransactionManagement</code> 注解即可开启事务支持。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;top.xiaorang.spring.transaction&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name"><span class="token namespace">top<span class="token punctuation">.</span>xiaorang<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span> <span class="token comment">//开启事务注解支持</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span>transactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>之后，哪个方法需要事务就在哪个方法上添加 <code>@Transactional</code> 注解即可，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>测试类改成使用 <code>MainConfig</code>，不使用 <code>XML</code> 配置文件。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">SpringExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>点击测试按钮，可以发现测试结果与使用 <code>XML</code> 配置时一模一样。</p> <p><img alt="image-20221022030808751" data-src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211120130391.png" loading="lazy" class="lazy"></p> <p>当然这个稍微有点代码入侵，不过问题不大，日常开发中这种方式使用较多。当 <code>@Transactional</code> 注解加在类上时，表示该类中的所有方法都有事务，该注解加在方法上面，表示只有该方法才有事务。</p> <h2 id="_4-事务属性"><a href="#_4-事务属性" class="header-anchor">#</a> 4. 事务属性</h2> <p>在前面的配置中，咱们只是提到事务的用法，并没有说到事务的一些属性细节，现在咱们就来自此捋一捋事务中的五大属性。</p> <h3 id="_4-1-隔离性"><a href="#_4-1-隔离性" class="header-anchor">#</a> 4.1. 隔离性</h3> <p>首先就是事务的隔离性，也就是事务的隔离级别。</p> <p>MySQL 中有四种不同的隔离级别，这四种不同的隔离级别在 Spring 中都得到了很好的支持。Spring 中默认的事务隔离级就是 <code>default</code>，即数据库本身的隔离级别是啥就是啥，<code>default</code> 就能满足咱们日常开发中的大部分场景，没有必要不需要修改。不过如果项目有需要，咱们也可以随时调整事务的隔离级别，调整方式如下：</p> <h4 id="_4-1-1-编程式事务隔离级别"><a href="#_4-1-1-编程式事务隔离级别" class="header-anchor">#</a> 4.1.1. 编程式事务隔离级别</h4> <p>如果是编程式事务，可以通过如下方式修改事务的隔离级别：</p> <h5 id="_4-1-1-1-transactiontemplate"><a href="#_4-1-1-1-transactiontemplate" class="header-anchor">#</a> 4.1.1.1. TransactionTemplate</h5> <p>在往 Spring 容器中注入 <code>TransactionTemplate</code> 组件的时候，由于 <code>TransactionTemplate</code> 继承自 <code>DefaultTransactionDefinition</code>，所以直接修改对象中的 <code>isolationLevel</code> 属性即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionTemplate<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_SERIALIZABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_4-1-1-2-platformtransactionmanager"><a href="#_4-1-1-2-platformtransactionmanager" class="header-anchor">#</a> 4.1.1.2. PlatformTransactionManager</h5> <p>调用 <code>PlatformTransactionManager</code> 组件中的 <code>getTransaction()</code> 方法获取一个事务对象时，需要传入一个 <code>TransactionDefinition</code> 接口的实现类对象，咱们传入的是 <code>TransactionDefinition</code> 的默认实现类 <code>DefaultTransactionDefinition</code> 对象，所以咱们也只需要直接修改对象中的 <code>isolationLevel</code> 属性即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">DefaultTransactionDefinition</span> transactionDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transactionDefinition<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_SERIALIZABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TransactionStatus</span> transactionStatus <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>transactionDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_4-1-2-声明式事务隔离级别"><a href="#_4-1-2-声明式事务隔离级别" class="header-anchor">#</a> 4.1.2. 声明式事务隔离级别</h4> <p>如果是声明式事务可以通过如下方式修改隔离级别：</p> <h5 id="_4-1-2-1-xml-配置"><a href="#_4-1-2-1-xml-配置" class="header-anchor">#</a> 4.1.2.1. XML 配置</h5> <p>修改 <code>m3()</code> 方法的事务隔离级别为 <code>SERIALIZABLE</code>。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">isolation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SERIALIZABLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m4<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_4-1-2-2-transactional-注解配置"><a href="#_4-1-2-2-transactional-注解配置" class="header-anchor">#</a> 4.1.2.2. @Transactional 注解配置</h5> <p>修改 <code>@Transactional</code> 注解中的 <code>isolation</code> 属性为 <code>SERIALIZABLE</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">SERIALIZABLE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_4-2-传播性"><a href="#_4-2-传播性" class="header-anchor">#</a> 4.2. 传播性</h3> <blockquote><p>事务传播行为是为了解决业务层方法之间互相调用的事务问题，当一个事务方法被另一个事务方法调用时，事务该以何种状态存在？例如新方法可能继续在现有事务中运行，也可能开启一个新事务，并在自己的事务中运行，等等，这些规则就涉及到事务的传播性。</p></blockquote> <p>关于事务的传播性，Spring 主要定义了如下七种：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Propagation</span> <span class="token punctuation">{</span>
    <span class="token function">REQUIRED</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SUPPORTS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">MANDATORY</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REQUIRES_NEW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">NOT_SUPPORTED</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">NEVER</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">NESTED</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Propagation</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>具体含义如下：</p> <table><thead><tr><th>传播性</th> <th>描述</th></tr></thead> <tbody><tr><td><code>REQUIRED</code></td> <td>如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</td></tr> <tr><td><code>SUPPORTS</code></td> <td>如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</td></tr> <tr><td><code>MANDATORY</code></td> <td>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</td></tr> <tr><td><code>REQUIRES_NEW</code></td> <td>创建一个新的事务，如果当前存在事务，则把当前事务挂起</td></tr> <tr><td><code>NOT_SUPPORTED</code></td> <td>以非事务运行，如果当前存在事务，则把当前事务挂起</td></tr> <tr><td><code>NEVER</code></td> <td>以非事务运行，如果当前存在事务，则抛出异常</td></tr> <tr><td><code>NESTED</code></td> <td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于 <code>REQUIRED</code></td></tr></tbody></table> <h4 id="_4-2-1-使用方式"><a href="#_4-2-1-使用方式" class="header-anchor">#</a> 4.2.1. 使用方式</h4> <p>配置传播性其实与配置隔离级别时的情况差不多。</p> <h5 id="_4-2-1-1-在-transactiontemplate-中的配置"><a href="#_4-2-1-1-在-transactiontemplate-中的配置" class="header-anchor">#</a> 4.2.1.1. 在 TransactionTemplate 中的配置</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_4-2-1-2-在-platformtransactionmanager-中的配置"><a href="#_4-2-1-2-在-platformtransactionmanager-中的配置" class="header-anchor">#</a> 4.2.1.2. 在 PlatformTransactionManager 中的配置</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">DefaultTransactionDefinition</span> transactionDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transactionDefinition<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TransactionStatus</span> transactionStatus <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>transactionDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_4-2-1-3-在-xml-中的配置"><a href="#_4-2-1-3-在-xml-中的配置" class="header-anchor">#</a> 4.2.1.3. 在 XML 中的配置</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>REQUIRED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m4<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_4-2-1-4-在-transactional-注解中的配置"><a href="#_4-2-1-4-在-transactional-注解中的配置" class="header-anchor">#</a> 4.2.1.4. 在 @Transactional 注解中的配置</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance + 100 where name = 'javaboy'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = balance - 100 where name = 'itboyhub'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_4-2-2-七种传播性演示"><a href="#_4-2-2-七种传播性演示" class="header-anchor">#</a> 4.2.2. 七种传播性演示</h4> <h5 id="_4-2-2-1-required"><a href="#_4-2-2-1-required" class="header-anchor">#</a> 4.2.2.1. REQUIRED</h5> <p><code>REQUIRED</code> 表示如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。</p> <p>例如有如下一段代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AccountService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = ? where id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService2</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AccountService</span> accountService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AccountService2</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">AccountService</span> accountService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountService <span class="token operator">=</span> accountService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = ? where name = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;javaboy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountService<span class="token punctuation">.</span><span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在 <code>handle2()</code> 方法中调用 <code>handle1()</code> 方法。那么：</p> <ol><li>如果 <code>handle2()</code> 方法本身是有事务的，则 <code>handle1()</code> 方法就会加入到 <code>handle2()</code> 方法所在的事务中，这样两个方法将处于同一个事务中，一起成功或者一起失败（不管 <code>handle2()</code> 方法还是 <code>handle1()</code> 方法谁抛异常，都会导致整体回滚）。</li> <li>如果 <code>handle2()</code> 方法本身是没有事务的，则 <code>handle1()</code> 方法就会自己开启一个新的事务，自己玩。</li></ol> <p>测试一下如下情况：<code>handle2()</code> 方法有事务，<code>handle1()</code> 方法也有事务。测试类如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">SpringExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">AccountService2Test</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountService2</span> accountService2<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        accountService2<span class="token punctuation">.</span><span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试结果如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-22 17:56:30.553 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-22 17:56:30.701 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] for JDBC transaction
2022-10-22 17:56:30.703 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] to manual commit
2022-10-22 17:56:30.708 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 17:56:30.708 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-22 17:56:30.725 [main] DEBUG o.s.j.d.DataSourceTransactionManager:470 - Participating in existing transaction
2022-10-22 17:56:30.728 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 17:56:30.728 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-22 17:56:30.729 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 17:56:30.729 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58]
2022-10-22 17:56:30.732 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>从打印出来的日志信息可以看出，在执行到 <code>handle2()</code> 方法的时候会开启一个新的事务（<code>Creating new transaction</code>），在执行到 <code>handle1()</code> 方法的时候会加入到 <code>handle2()</code> 方法所在的事务（<code>Participating in existing transaction</code>），并不会再开启一个新的事务。</p> <h5 id="_4-2-2-2-requires-new"><a href="#_4-2-2-2-requires-new" class="header-anchor">#</a> 4.2.2.2. REQUIRES_NEW</h5> <p><code>REQUIRES_NEW</code> 表示创建一个新的事务，如果当前存在事务，则把 <strong>当前事务挂起</strong>。换言之，不管外部方法是否有事务，<code>REQUIRES_NEW</code> 都会开启自己的事务。</p> <p>有的小伙伴可能觉得 <code>REQUIRES_NEW</code> 与 <code>REQUIRED</code> 很像，似乎没啥区别。其实要是单纯看最终的回滚效果，可能确实看不到啥区别。但是，在 <code>REQUIRES_NEW</code> 中可能会同时存在两个事务，外部方法的事务被挂起，内部方法的事务独立运行，而在 <code>REQUIRED</code> 中则不会出现这种情况，如果内外部方法传播性都是 <code>REQUIRED</code>，那么最终也只是一个事务。</p> <p>还是上面那个例子，假设 <code>handle1()</code> 方法和 <code>handle2()</code> 方法都有事务，<code>handle2()</code> 方法的事务传播性是 <code>REQUIRED</code>，而 <code>handle1()</code> 方法的事务传播性是 <code>REQUIRES_NEW</code>，那么最终打印出来的事务日志如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-22 18:15:29.139 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-22 18:15:29.265 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] for JDBC transaction
2022-10-22 18:15:29.268 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] to manual commit
2022-10-22 18:15:29.273 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 18:15:29.273 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-22 18:15:29.290 [main] DEBUG o.s.j.d.DataSourceTransactionManager:429 - Suspending current transaction, creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService.handle1]
2022-10-22 18:15:29.294 [HikariPool-1 connection adder] DEBUG c.z.h.p.HikariPool:738 - HikariPool-1 - Added connection com.mysql.cj.jdbc.ConnectionImpl@26f5a28e
2022-10-22 18:15:29.294 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@2104842259 wrapping com.mysql.cj.jdbc.ConnectionImpl@26f5a28e] for JDBC transaction
2022-10-22 18:15:29.295 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@2104842259 wrapping com.mysql.cj.jdbc.ConnectionImpl@26f5a28e] to manual commit
2022-10-22 18:15:29.298 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 18:15:29.299 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-22 18:15:29.300 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 18:15:29.300 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@2104842259 wrapping com.mysql.cj.jdbc.ConnectionImpl@26f5a28e]
2022-10-22 18:15:29.300 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@2104842259 wrapping com.mysql.cj.jdbc.ConnectionImpl@26f5a28e] after transaction
2022-10-22 18:15:29.304 [main] DEBUG o.s.j.d.DataSourceTransactionManager:996 - Resuming suspended transaction after completion of inner transaction
2022-10-22 18:15:29.305 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 18:15:29.305 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58]
2022-10-22 18:15:29.305 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>分析这段日志可以看出：</p> <ol><li>首先为 <code>handle2()</code> 方法开启一个新事务 <code>Creating new transaction</code></li> <li>执行完 <code>handle2()</code> 方法中的 SQL 之后，先将当前存在的事务挂起，然后为 <code>handle1()</code> 方法开启一个新的事务 <code>Suspending current transaction, creating new transaction</code></li> <li>执行完 <code>handle1()</code> 方法中的 SQL，提交 <code>handle1()</code> 方法的事务</li> <li>恢复被挂起的事务 <code>Resuming suspended transaction after completion of inner transaction</code></li> <li>提交 <code>handle2()</code> 方法的事务</li></ol> <p>从这段日志中大家可以非常明确的看到 <code>REQUIRES_NEW</code> 与 <code>REQUIRED</code> 的区别。</p> <p>再来简单总结一下（假设 <code>handle1()</code> 方法的传播性是 <code>REQUIRES_NEW</code>）：</p> <ol><li>如果 <code>handle2()</code> 方法没有事务，<code>handle1()</code> 方法会自己开启一个事务自己玩</li> <li>如果 <code>handle2()</code> 方法有事务，<code>handle1()</code> 方法还是会开启一个事务。此时，如果 <code>handle2()</code> 方法发生了异常进行回滚，并不会导致 <code>handle1()</code> 方法回滚，因为 <code>handle1()</code> 方法是独立的事务；如果 <code>handle1()</code> 方法发生了异常导致回滚，并且 <code>handle1()</code> 方法的异常没有被捕获处理传到了 <code>handle2()</code> 方法中，那么也会导致 <code>handle2()</code> 方法回滚。</li></ol> <blockquote><p>这个地方小伙伴们要稍微注意一下，在测试的时候，由于是两个更新语句，如果更新的查询字段不是索引字段，那么 InnoDB 将使用表锁，这样就会发生死锁（<code>handle1()</code> 方法执行时开启表锁，导致 <code>handle1()</code> 陷入等待中，而必须等 <code>handle1()</code> 方法执行完，<code>handle2()</code> 方法才能释放锁）。所以，在上面的测试中，需要将 <code>name</code> 字段设置为索引字段，这样默认就使用行锁了。</p></blockquote> <h5 id="_4-2-2-3-nested"><a href="#_4-2-2-3-nested" class="header-anchor">#</a> 4.2.2.3. NESTED</h5> <p><code>NESTED</code><strong>(嵌套)</strong>，表示如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于 <code>REQUIRED</code>，即创建一个新的事务。</p> <p>假设 <code>handle2()</code> 方法有事务,<code>handle1()</code> 方法也有事务并且传播性为 <code>NESTED</code>，那么最终打印出来的事务日志如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-22 19:12:11.495 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-22 19:12:11.633 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] for JDBC transaction
2022-10-22 19:12:11.636 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] to manual commit
2022-10-22 19:12:11.641 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:12:11.642 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-22 19:12:11.655 [main] DEBUG o.s.j.d.DataSourceTransactionManager:449 - Creating nested transaction with name [top.xiaorang.spring.transaction.service.AccountService.handle1]
2022-10-22 19:12:11.662 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:12:11.663 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-22 19:12:11.663 [main] DEBUG o.s.j.d.DataSourceTransactionManager:733 - Releasing transaction savepoint
2022-10-22 19:12:11.663 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 19:12:11.664 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58]
2022-10-22 19:12:11.664 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>关键一句在 <code>Creating nested transaction</code>。此时，<code>NESTED</code> 修饰的内部方法 <code>handle1()</code> 方法属于外部事务的子事务，外部主事务回滚的话，子事务也会回滚，而内部子事务可以单独回滚而不影响外部主事务和其他子事务（前提是需要处理掉内部子事务的异常）。</p> <h5 id="_4-2-2-4-mandatory"><a href="#_4-2-2-4-mandatory" class="header-anchor">#</a> 4.2.2.4. MANDATORY</h5> <p><code>MANDATORY</code><strong>(强制性的)</strong>，表示如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</p> <p>这个好理解，举两个例子：</p> <p>假设 <code>handle2()</code> 方法有事务,<code>handle1()</code> 方法也有事务并且传播性为 <code>MANDATORY</code>，那么最终打印出来的事务日志如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-22 19:21:21.616 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-22 19:21:21.739 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] for JDBC transaction
2022-10-22 19:21:21.739 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] to manual commit
2022-10-22 19:21:21.745 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:21:21.745 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-22 19:21:21.755 [main] DEBUG o.s.j.d.DataSourceTransactionManager:470 - Participating in existing transaction
2022-10-22 19:21:21.755 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:21:21.755 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-22 19:21:21.765 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 19:21:21.765 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58]
2022-10-22 19:21:21.765 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>从打印出来的日志信息可以看出，在执行到 <code>handle2()</code> 方法的时候会开启一个新的事务（<code>Creating new transaction</code>），在执行到 <code>handle1()</code> 方法的时候会加入到 <code>handle2()</code> 方法所在的事务（<code>Participating in existing transaction</code>），并不会再开启一个新的事务。效果等价于 <code>REQUIRED</code>。</p> <p>假设 <code>handle2()</code> 方法无事务,<code>handle1()</code> 方法有事务并且传播性为 <code>MANDATORY</code>，那么最终执行时会抛出如下异常：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>org.springframework.transaction.IllegalTransactionStateException: No existing transaction found for transaction marked with propagation 'mandatory'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由于没有已经存在的事务，所以会抛出异常。</p> <h5 id="_4-2-2-5-supports"><a href="#_4-2-2-5-supports" class="header-anchor">#</a> 4.2.2.5. SUPPORTS</h5> <p><code>SUPPORTS</code> 表示如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</p> <p>这个也很简单，举两个例子大家就明白了。</p> <p>假设 <code>handle2()</code> 方法有事务,<code>handle1()</code> 方法也有事务并且传播性为 <code>SUPPORTS</code>，那么最终打印出来的事务日志如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-22 19:28:43.871 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-22 19:28:44.003 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] for JDBC transaction
2022-10-22 19:28:44.005 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] to manual commit
2022-10-22 19:28:44.009 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:28:44.010 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-22 19:28:44.022 [main] DEBUG o.s.j.d.DataSourceTransactionManager:470 - Participating in existing transaction
2022-10-22 19:28:44.026 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-22 19:28:44.026 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-22 19:28:44.027 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-22 19:28:44.027 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58]
2022-10-22 19:28:44.028 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@1175154004 wrapping com.mysql.cj.jdbc.ConnectionImpl@2787de58] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这段日志很简单，没啥好说的，认证 <code>Participating in existing transaction</code> 表示加入到已经存在的事务中即可。效果等价于 <code>REQUIRED</code>。</p> <p>假设 <code>handle2()</code> 方法无事务,<code>handle1()</code> 方法有事务并且传播性为 <code>SUPPORTS</code>，这个最终就不会开启事务，也就没有事务相关日志。</p> <h5 id="_4-2-2-6-not-supported"><a href="#_4-2-2-6-not-supported" class="header-anchor">#</a> 4.2.2.6. NOT_SUPPORTED</h5> <p><code>NOT_SUPPORTED</code> 表示以非事务方式运行，如果当前存在事务，则把当前事务挂起。</p> <p>假设 <code>handle2()</code> 方法有事务,<code>handle1()</code> 方法也有事务并且传播性为 <code>NOT_SUPPORTED</code>，那么最终打印出来的事务日志如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2022-10-23 01:18:24.633 [main] DEBUG o.s.j.d.DataSourceTransactionManager:370 - Creating new transaction with name [top.xiaorang.spring.transaction.service.AccountService2.handle2]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-10-23 01:18:24.844 [main] DEBUG o.s.j.d.DataSourceTransactionManager:267 - Acquired Connection [HikariProxyConnection@666312528 wrapping com.mysql.cj.jdbc.ConnectionImpl@5b022357] for JDBC transaction
2022-10-23 01:18:24.847 [main] DEBUG o.s.j.d.DataSourceTransactionManager:285 - Switching JDBC Connection [HikariProxyConnection@666312528 wrapping com.mysql.cj.jdbc.ConnectionImpl@5b022357] to manual commit
2022-10-23 01:18:24.853 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-23 01:18:24.854 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where name = ?]
2022-10-23 01:18:24.869 [main] DEBUG o.s.j.d.DataSourceTransactionManager:419 - Suspending current transaction
2022-10-23 01:18:24.873 [main] DEBUG o.s.j.c.JdbcTemplate:958 - Executing prepared SQL update
2022-10-23 01:18:24.873 [main] DEBUG o.s.j.c.JdbcTemplate:643 - Executing prepared SQL statement [update account set balance = ? where id = ?]
2022-10-23 01:18:24.873 [main] DEBUG o.s.j.d.DataSourceUtils:116 - Fetching JDBC Connection from DataSource
2022-10-23 01:18:24.879 [HikariPool-1 connection adder] DEBUG c.z.h.p.HikariPool:738 - HikariPool-1 - Added connection com.mysql.cj.jdbc.ConnectionImpl@6a7ec6dd
2022-10-23 01:18:24.885 [main] DEBUG o.s.j.d.DataSourceTransactionManager:996 - Resuming suspended transaction after completion of inner transaction
2022-10-23 01:18:24.885 [main] DEBUG o.s.j.d.DataSourceTransactionManager:740 - Initiating transaction commit
2022-10-23 01:18:24.886 [main] DEBUG o.s.j.d.DataSourceTransactionManager:330 - Committing JDBC transaction on Connection [HikariProxyConnection@666312528 wrapping com.mysql.cj.jdbc.ConnectionImpl@5b022357]
2022-10-23 01:18:24.887 [main] DEBUG o.s.j.d.DataSourceTransactionManager:389 - Releasing JDBC Connection [HikariProxyConnection@666312528 wrapping com.mysql.cj.jdbc.ConnectionImpl@5b022357] after transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这段日志大家认准这两句就行了：<code>Suspending current transaction</code> 表示挂起当前事务，<code>Resuming suspended transaction after completion of inner transaction</code> 表示恢复挂起的事务。</p> <h5 id="_4-2-2-7-never"><a href="#_4-2-2-7-never" class="header-anchor">#</a> 4.2.2.7. NEVER</h5> <p><code>NEVER</code> 表示以非事务方式运行，如果当前存在事务，则抛出异常。</p> <p>假设 <code>handle2()</code> 方法有事务,<code>handle1()</code> 方法也有事务并且传播性为 <code>NEVER</code>，那么最终执行时会抛出如下异常：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>org.springframework.transaction.IllegalTransactionStateException: Existing transaction found for transaction marked with propagation 'never'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-3-回滚规则"><a href="#_4-3-回滚规则" class="header-anchor">#</a> 4.3. 回滚规则</h3> <p>默认情况下，事务只有遇到运行时异常（<code>RuntimeException</code> 的子类）以及 <code>Error</code> 时才会回滚，在遇到检查型异常（<code>Checked Exception</code>）时不会回滚。</p> <p>像 <code>1 / 0</code>，空指针这些是 <code>RuntimeException</code>，而 <code>IOException</code> 则算是 <code>Checked Exception</code>，换言之，默认情况下，如果发生 <code>IOException</code> 并不会导致事务回滚。</p> <p>咱们如果希望发生 <code>IOException</code> 时也能触发事务回滚，那么可以按照如下方式配置：</p> <ul><li><p>Java 配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">IOException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = ? where name = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;javaboy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accountService<span class="token punctuation">.</span><span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>XML 配置</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rollback-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.io.IOException<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p>另外，咱们也可以指定在发生某些异常时不回滚，例如当系统抛出 <code>ArithmeticException</code> 异常时并不要触发事务回滚，则可以如下配置：</p> <ul><li><p>Java 配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>noRollbackFor <span class="token operator">=</span> <span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set balance = ? where name = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;javaboy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accountService<span class="token punctuation">.</span><span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>XML 配置</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">no-rollback-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.ArithmeticException<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <h3 id="_4-4-是否只读"><a href="#_4-4-是否只读" class="header-anchor">#</a> 4.4. 是否只读</h3> <p>只读事务一般设置在查询方法上，但不是所有的查询方法都需要只读事务，要看具体情况。</p> <p>一般来说，如果这个业务方法只有一个查询 SQL，那么就没必要添加事务，强行添加最终效果适得其反。</p> <p>但是如果一个业务方法中有多个查询 SQL，情况就不一样了：多个查询 SQL，默认情况下，每个查询 SQL 都会开启一个独立的事务，这样，如果有并发操作修改了数据，那么多个查询 SQL 就会查到不一样的数据。此时，如果咱们开启事务，并设置为只读事务，那么多个查询 SQL 将被置于同一个事务中，多条相同的 SQL 在该事务中执行将会获取到相同的查询结果。</p> <p>设置事务只读的方式如下：</p> <ul><li><p>Java 配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>XML 配置</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <h3 id="_4-5-超时时间"><a href="#_4-5-超时时间" class="header-anchor">#</a> 4.5. 超时时间</h3> <p>超时时间是说一个事务允许执行的最长时间，如果超过该时间限制但事务还没有完成，则自动回滚事务。</p> <p>事务超时时间配置方式如下（单位为秒）：</p> <ul><li><p>Java 配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>XML 配置</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p>在 <code>TransactionDefinition</code> 中以 <code>int</code> 的值来表示超时时间，其单位是秒，默认值为 <code>-1</code>。</p> <h2 id="_5-注意事项"><a href="#_5-注意事项" class="header-anchor">#</a> 5. 注意事项</h2> <ol><li>事务只能应用到 <code>public</code> 方法上才会有效。</li> <li>事务需要从外部调用，<strong>Spring 自调事务会失效</strong>。即相同类里面，A 方法没有事务，B 方法有事务，A 方法调用 B 方法，则 B 方法的事务会失效，这点尤其要注意，因为代理模式只拦截通过代理传入的外部方法调用，所以自调用事务是不生效的。</li> <li>建议事务注解 <code>@Transactional</code> 一般添加在实现类上，而不要定义在接口上，如果加在接口类或接口方法上时，只有配置基于接口的代理这个注解才会生效。</li></ol> <h2 id="_6-参考资料"><a href="#_6-参考资料" class="header-anchor">#</a> 6. 参考资料</h2> <ul><li><a href="http://www.javaboy.org/2021/1026/spring_transaction.html" target="_blank" rel="noopener noreferrer">长文捋明白 Spring 事务！隔离性？传播性？一网打尽！ - 江南一点雨 (javaboy.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xihuanxiaorang/CodeGuide/edit/main/docs/md/spring全家桶/spring/基础/事务.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/11/13</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/md/spring全家桶/spring/基础/JDBC.html" class="prev">
          Spring-JDBC
        </a></span> <span class="next"><a href="/blog/md/spring全家桶/spring/基础/Spring注解驱动开发.html">
          Spring注解驱动开发
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">Spring事务</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-环境搭建" class="toc-sidebar-link">1. 环境搭建</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-1-创建-spring-study-transaction-模块" class="toc-sidebar-link">1.1. 创建 spring-study-transaction 模块</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-2-引入相关依赖" class="toc-sidebar-link">1.2. 引入相关依赖</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-3-引入日志配置文件" class="toc-sidebar-link">1.3. 引入日志配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-4-事务配置类" class="toc-sidebar-link">1.4. 事务配置类</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-5-主配置类" class="toc-sidebar-link">1.5. 主配置类</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-三大基础设施" class="toc-sidebar-link">2. 三大基础设施</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-1-platformtransactionmanager" class="toc-sidebar-link">2.1. PlatformTransactionManager</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-2-transactiondefinition" class="toc-sidebar-link">2.2. TransactionDefinition</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-3-transactionstatus" class="toc-sidebar-link">2.3. TransactionStatus</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-两种用法" class="toc-sidebar-link">3. 两种用法</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-1-编程式事务" class="toc-sidebar-link">3.1. 编程式事务</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-2-声明式事务" class="toc-sidebar-link">3.2. 声明式事务</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-事务属性" class="toc-sidebar-link">4. 事务属性</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-1-隔离性" class="toc-sidebar-link">4.1. 隔离性</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-2-传播性" class="toc-sidebar-link">4.2. 传播性</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-3-回滚规则" class="toc-sidebar-link">4.3. 回滚规则</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-4-是否只读" class="toc-sidebar-link">4.4. 是否只读</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-5-超时时间" class="toc-sidebar-link">4.5. 超时时间</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_5-注意事项" class="toc-sidebar-link">5. 注意事项</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_6-参考资料" class="toc-sidebar-link">6. 参考资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">Spring事务</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-环境搭建" class="toc-sidebar-link">1. 环境搭建</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-1-创建-spring-study-transaction-模块" class="toc-sidebar-link">1.1. 创建 spring-study-transaction 模块</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-2-引入相关依赖" class="toc-sidebar-link">1.2. 引入相关依赖</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-3-引入日志配置文件" class="toc-sidebar-link">1.3. 引入日志配置文件</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-4-事务配置类" class="toc-sidebar-link">1.4. 事务配置类</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_1-5-主配置类" class="toc-sidebar-link">1.5. 主配置类</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-三大基础设施" class="toc-sidebar-link">2. 三大基础设施</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-1-platformtransactionmanager" class="toc-sidebar-link">2.1. PlatformTransactionManager</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-2-transactiondefinition" class="toc-sidebar-link">2.2. TransactionDefinition</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_2-3-transactionstatus" class="toc-sidebar-link">2.3. TransactionStatus</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-两种用法" class="toc-sidebar-link">3. 两种用法</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-1-编程式事务" class="toc-sidebar-link">3.1. 编程式事务</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_3-2-声明式事务" class="toc-sidebar-link">3.2. 声明式事务</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-事务属性" class="toc-sidebar-link">4. 事务属性</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-1-隔离性" class="toc-sidebar-link">4.1. 隔离性</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-2-传播性" class="toc-sidebar-link">4.2. 传播性</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-3-回滚规则" class="toc-sidebar-link">4.3. 回滚规则</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-4-是否只读" class="toc-sidebar-link">4.4. 是否只读</a></li><li class="toc-sidebar-sub-header"><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_4-5-超时时间" class="toc-sidebar-link">4.5. 超时时间</a></li></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_5-注意事项" class="toc-sidebar-link">5. 注意事项</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/blog/md/spring%E5%85%A8%E5%AE%B6%E6%A1%B6/spring/%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1.html#_6-参考资料" class="toc-sidebar-link">6. 参考资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.png" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="Spring-JDBC" class="option-box" style="padding-left:2px;text-align:center;"><a href="/blog/md/spring全家桶/spring/基础/JDBC.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="Spring注解驱动开发" class="option-box" style="padding-left:2px;text-align:center;"><a href="/blog/md/spring全家桶/spring/基础/Spring注解驱动开发.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <div class="page-side-sitemap"><div class="option-box"><img src="/images/system/sitemap.png" class="nozoom img"> <span class="show-txt">站点图</span> <div class="sitemap-container"><h4>站点导航图
              <a href="/blog/md/about/me/2020-08-25-13年毕业，用两年时间从外包走进互联网大厂.html" class="sitemap-top-link"> 关于我</a> <a href="/blog/md/about/study/2020-04-30-讲道理，只要你是一个爱折腾的程序员，毕业找工作真的不需要再花钱培训.html" class="sitemap-top-link"> 关于学习</a> <a href="/blog/md/about/job/2020-11-15-BATJTMD，大厂招聘，都招什么样Java程序员？.html" class="sitemap-top-link"> 关于职场</a></h4> <table class="sitemap-table"><tr><td nowrap="nowrap"><div class="sitemap-col-group">常用搜索</div></td> <td><div class="sitemap-col-item"><a href="http://www.baidu.com/" target="_blank" title="百度">  
          百度
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.google.com/" target="_blank" title="Google">  
          Google
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.bing.com/" target="_blank" title="Bing">  
          Bing
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://github.com" target="_blank" title="Github">  
          Github
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.programcreek.com/java-api-examples/index.php" target="_blank" title="搜代码">  
          搜代码
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">技术社区</div></td> <td><div class="sitemap-col-item"><a href="http://www.csdn.net/" target="_blank" title="CDSN">  
          CDSN
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.cnblogs.com/" target="_blank" title="博客园">  
          博客园
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.oschina.net" target="_blank" title="OSChina">  
          OSChina
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://segmentfault.com/" target="_blank" title="思否">  
          思否
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://juejin.im" target="_blank" title="掘金">  
          掘金
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.linuxidc.com/" target="_blank" title="Linux公社">  
          Linux公社
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.ibm.com/developerworks/cn/" target="_blank" title="IBM 开发者">  
          IBM 开发者
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://stackoverflow.com" target="_blank" title="StackOverflow">  
          StackOverflow
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">Spring</div></td> <!----> <td><a href="/blog/md/spring/source-code/index.html" class="sitemap-col-item">
          Spring 源码分析
        </a></td></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">面向对象</div></td> <!----> <td><a href="/blog/md/develop/design-pattern/index.html" class="sitemap-col-item">
          设计模式
        </a></td></tr></table></div></div></div> <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/cg-styles.js?v=1668302853734" defer></script><script src="/blog/assets/js/cg-3.js?v=1668302853734" defer></script><script src="/blog/assets/js/cg-4.js?v=1668302853734" defer></script><script src="/blog/assets/js/cg-22.js?v=1668302853734" defer></script><script src="/blog/assets/js/cg-app.js?v=1668302853734" defer></script>
  </body>
</html>
